<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lidarr Downloader</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='currentColor' d='M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z'%3E%3C/path%3E%3C/svg%3E">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #ffffff;
            --surface: #f3f4f6;
            --border: #e5e7eb;
            --text: #111827;
            --text-dim: #6b7280;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --error: #ef4444;
            --card-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        header {
            background-color: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 15px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--card-shadow);
        }

        .logo-area { display: flex; align-items: center; gap: 12px; }
        .logo-icon {
            width: 28px;
            height: 28px;
            fill: var(--accent);
            display: block;
        }
        .logo-text {
            font-weight: 800; font-size: 1.2rem;
            color: var(--text);
        }

        .controls { display: flex; gap: 10px; align-items: center; }
        
        .search-input {
            background: var(--bg); border: 1px solid var(--border); color: var(--text);
            padding: 10px; border-radius: 8px; width: 100%; max-width: 250px;
            font-size: 0.9rem; outline: none;
        }

        .theme-toggle {
            background: none; border: 1px solid var(--border); color: var(--text-dim);
            padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 1.2rem;
            line-height: 1;
        }

        main {
            flex: 1; width: 100%; max-width: 1200px; margin: 20px auto; padding: 0 15px;
        }

        .artist-group {
            margin-bottom: 25px; background: var(--surface); border-radius: 12px;
            border: 1px solid var(--border); overflow: hidden; box-shadow: var(--card-shadow);
        }
        
        .artist-header {
            background: rgba(0,0,0,0.05); padding: 12px 20px; border-bottom: 1px solid var(--border);
            font-weight: 700; font-size: 1.1rem; color: var(--accent);
        }

        .album-list { display: flex; flex-direction: column; }

        .album-row {
            display: flex; align-items: center; padding: 15px 20px;
            border-bottom: 1px solid var(--border); gap: 15px;
            justify-content: space-between; flex-wrap: wrap;
        }
        .album-row:last-child { border-bottom: none; }
        .album-row:hover { background-color: rgba(255,255,255,0.03); }

        .album-info { flex: 1; min-width: 200px; }
        .album-title { font-weight: 600; font-size: 1rem; margin-bottom: 4px; }
        .album-year {
            color: var(--text-dim); font-size: 0.8rem; font-family: monospace;
            background: var(--bg); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border);
            display: inline-block;
        }

        .album-actions {
            display: flex; align-items: center; gap: 15px; justify-content: flex-end;
            min-width: 150px;
        }

        .btn-download {
            background-color: var(--accent); color: white; border: none; padding: 10px 20px;
            border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem;
            white-space: nowrap;
        }
        .btn-download:hover { background-color: var(--accent-hover); }
        
        .status-box { display: none; text-align: right; width: 100%; }
        .status-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: 2px;
        }
        .status-text { font-size: 0.75rem; color: var(--text-dim); }
        .status-speed { font-size: 0.75rem; color: var(--accent); font-weight: 600; }
        .status-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 4px; width: 100%; min-width: 120px;}
        .status-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s; }
        
        .status-done { color: var(--success); font-weight: 600; display: none; font-size: 0.9rem; }
        .status-err { color: var(--error); font-weight: 600; display: none; font-size: 0.9rem; }

        @media (max-width: 600px) {
            header { flex-direction: column; align-items: stretch; }
            .controls { justify-content: space-between; }
            .search-input { max-width: 100%; }
            .album-row { flex-direction: column; align-items: flex-start; gap: 10px; }
            .album-actions { width: 100%; justify-content: stretch; }
            .btn-download { width: 100%; }
            .status-box, .status-text, .status-done, .status-err { text-align: left; }
            .status-line { justify-content: flex-start; }
        }

        footer {
            text-align: center; padding: 20px; color: var(--text-dim); font-size: 0.85rem;
            border-top: 1px solid var(--border); margin-top: auto;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <div class="logo-area">
            <svg class="logo-icon" viewBox="0 0 24 24">
                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
            </svg>
            <div class="logo-text">Lidarr Downloader</div>
        </div>
        
        <div class="controls">
            <input type="text" id="searchInput" class="search-input" placeholder="Filter..." onkeyup="filterList()">
            <button class="theme-toggle" onclick="toggleTheme()">‚óë</button>
        </div>
    </header>

    <main>
        {% if albums|length == 0 %}
        <div style="text-align: center; padding: 50px; color: var(--text-dim);">
            <h2>üéâ All caught up!</h2>
            <p>No missing albums found in Lidarr.</p>
        </div>
        {% endif %}

        {% for artist, items in albums|groupby('artist') %}
        <div class="artist-group" data-artist="{{ artist|lower }}">
            <div class="artist-header">üë§ {{ artist }}</div>
            <div class="album-list">
                {% for album in items %}
                <div class="album-row" data-search="{{ artist|lower }} {{ album.title|lower }}">
                    <div class="album-info">
                        <div class="album-title">{{ album.title }}</div>
                        <span class="album-year">{{ album.year }}</span>
                    </div>
                    
                    <div class="album-actions">
                        <button class="btn-download" id="btn-{{ album.id }}" 
                                onclick="startDownload({{ album.id }}, '{{ album.title|replace('\'', '\\\'') }}', '{{ album.artist|replace('\'', '\\\'') }}', '{{ album.artistId }}', '{{ album.mbId }}', '{{ album.coverUrl }}')">
                            ‚¨á Download
                        </button>

                        <div class="status-box" id="status-{{ album.id }}">
                            <div class="status-line">
                                <span class="status-text" id="txt-{{ album.id }}">Starting...</span>
                                <span class="status-speed" id="speed-{{ album.id }}"></span>
                            </div>
                            <div class="status-bar"><div class="status-fill" id="fill-{{ album.id }}"></div></div>
                        </div>

                        <div class="status-done" id="done-{{ album.id }}">‚úî Imported</div>
                        <div class="status-err" id="err-{{ album.id }}">‚ö† Error</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </main>

    <footer>
        Made with love ‚ù§Ô∏è for the community
    </footer>

    <script>
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }
        initTheme();

        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }

        function filterList() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const groups = document.querySelectorAll('.artist-group');

            groups.forEach(group => {
                const rows = group.querySelectorAll('.album-row');
                let visibleRows = 0;

                rows.forEach(row => {
                    const text = row.getAttribute('data-search');
                    if (text.includes(input)) {
                        row.classList.remove('hidden');
                        visibleRows++;
                    } else {
                        row.classList.add('hidden');
                    }
                });

                if (visibleRows === 0) {
                    group.classList.add('hidden');
                } else {
                    group.classList.remove('hidden');
                }
            });
        }

        function startDownload(id, title, artist, artistId, mbId, coverUrl) {
            const btn = document.getElementById(`btn-${id}`);
            const statusBox = document.getElementById(`status-${id}`);
            
            if(btn) btn.style.display = 'none';
            if(statusBox) statusBox.style.display = 'block';

            fetch('/start_download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    id: id, 
                    title: title, 
                    artist: artist, 
                    artistId: artistId, 
                    mbId: mbId,
                    coverUrl: coverUrl
                })
            })
            .then(res => res.json())
            .then(data => {
                trackProgress(id);
            })
            .catch(err => {
                console.error(err);
                alert("Error connecting to server.");
            });
        }

        function trackProgress(id) {
            const interval = setInterval(() => {
                fetch(`/status/${id}`)
                .then(res => res.json())
                .then(data => {
                    const fill = document.getElementById(`fill-${id}`);
                    const txt = document.getElementById(`txt-${id}`);
                    const speed = document.getElementById(`speed-${id}`);
                    const statusBox = document.getElementById(`status-${id}`);
                    const doneMsg = document.getElementById(`done-${id}`);
                    const errMsg = document.getElementById(`err-${id}`);

                    if (!statusBox || !doneMsg || !errMsg) {
                        clearInterval(interval);
                        return;
                    }

                    if (data.state === 'downloading') {
                        if(fill) fill.style.width = data.percent + '%';
                        if(txt) txt.innerText = `Downloading ${data.current}/${data.total}`;
                        if(speed) speed.innerText = data.speed_str || "";
                    }
                    
                    if (data.state === 'importing') {
                        if(fill) fill.style.width = '100%';
                        if(txt) txt.innerText = `Importing...`;
                        if(speed) speed.innerText = "";
                    }

                    if (data.state === 'imported') {
                        clearInterval(interval);
                        statusBox.style.display = 'none';
                        doneMsg.style.display = 'block';
                    }
                    
                    if (data.state === 'import_failed') {
                        clearInterval(interval);
                        statusBox.style.display = 'none';
                        errMsg.style.display = 'block';
                        errMsg.innerText = '‚ö† Import Failed';
                    }
                    
                    if (data.state === 'error') {
                        clearInterval(interval);
                        statusBox.style.display = 'none';
                        errMsg.style.display = 'block';
                        errMsg.innerText = '‚ö† Download Failed';
                    }
                })
                .catch(() => clearInterval(interval));
            }, 1500);
        }
    </script>

</body>
</html>
